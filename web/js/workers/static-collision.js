(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
'use strict';

/*  static collision detection worker */

var distance2d = function distance2d(a, b) {
	return Math.sqrt(Math.pow(a[0] - b[0], 2) + Math.pow(a[2] - b[2], 2));
},
    distance2dCompare = function distance2dCompare(a, b, n) {
	// more efficient version of distance2d()
	return Math.pow(a[0] - b[0], 2) + Math.pow(a[2] - b[2], 2) < n * n;
},
    distance3dCompare = function distance3dCompare(a, b, n) {
	// ..faster than using Math.sqrt()
	return Math.pow(a[0] - b[0], 2) + Math.pow(a[1] - b[1], 2) + Math.pow(a[2] - b[2], 2) < n * n;
};

var observer = {
	position: [0, 0, 0],
	prevPos: [0, 0, 0],
	velocity: [0, 0, 0],
	vrHeight: 1.66
},
    voxelList = [],
    voxels = [];

self.update = function () {

	var distance = 0,
	    position = observer.position,
	    innerBox = [false, false],
	    velocity = observer.velocity,
	    vrHeight = observer.vrHeight,
	    collision = false,
	    yPos = 0,
	    voxel = null,
	    ent = null,
	    entRadius = 10,
	    structure = null,
	    bounds = [0, 0],
	    voxel = null,
	    delta = [0, 0],
	    oPos = [],
	    speed = 0,
	    e = 0,
	    i = 0,
	    v = 0;

	for (i = 0; i < voxelList.length; i++) {
		voxel = voxelList[i];

		if (!!!voxel || !!!voxel.position) continue;
		if (!!voxel && distance2dCompare(position, voxel.position, 180)) {
			// do collisions on voxels & structures... just walls at first..		
			if (voxel.loaded == undefined) {
				voxel.loaded = true;
				self.postMessage('{"command": "load entities", "data":{"coords":"' + voxel.cell[0] + '.' + voxel.cell[1] + '.' + voxel.cell[2] + '"}}');
			}
			if (distance2dCompare(position, voxel.position, 60)) {

				var alt = voxel.altitude || 0;

				yPos = voxel.position[1];
				if (distance2dCompare(position, voxel.position, 24.5)) {
					if (position[1] > yPos - 21 + vrHeight && position[1] < 14.25 + yPos + (vrHeight != 0 ? vrHeight + 0.25 : 0)) {
						collision = true;
						self.postMessage('{"command": "platform collision", "data":{"type":"top", "position":[' + voxel.position[0] + ',' + yPos + ',' + voxel.position[2] + '] }}');
					}
				}
				if (!!voxel.entities && voxel.entities.length > 0) {
					collision = self.checkStaticCollisions(voxel, position);
				}
			}
		}
	}

	if (!collision) observer.prevPos = [observer.position[0], observer.position[1], observer.position[2]];

	self.postMessage('{"command": "update"}');
	self.updateLoop = setTimeout(function () {
		self.update();
	}, 15);
};

self.checkStaticCollisions = function (voxel, position) {
	var e = voxel.entities.length - 1,
	    ent = null,
	    entRadius = 10,
	    collision = false;

	while (e >= 0) {
		ent = voxel.entities[e];
		entRadius = ent.boundingRadius;
		if (!!!ent || !!!ent.components) {
			console.warn("Problem with entity! ", e, ent);continue;
		}
		if (distance3dCompare(position, [ent.position[0] - entRadius, ent.position[1], ent.position[2] - entRadius], (entRadius * 1.6 || 3) + 2.5)) {

			ent.components.map(function (entComp) {
				var boundingRadius = entComp.boundingRadius * 1.2 || Math.max(entComp.props.geometry.size[0], entComp.props.geometry.size[2]) * 1.4;

				if (!!entComp.props.floor) {
					if (distance2dCompare(position, [ent.position[0] + entComp.position[0], 0, ent.position[2] + entComp.position[2]], boundingRadius * 2.2)) {
						var verticalOffset = position[1] + 2 - (entComp.position[1] + ent.position[1]); //  + entComp.geometry ? entComp.geometry.size[1] : 1
						if (verticalOffset > 0 && verticalOffset < 5) {
							self.postMessage(JSON.stringify({
								command: "floor collision", data: {
									position: entComp.position,
									floorData: entComp.props.floor
								}
							}));
							collision = true;
						}
					}
				} else if (distance3dCompare(position, [ent.position[0] + entComp.position[0], ent.position[1] + entComp.position[1], ent.position[2] + entComp.position[2]], boundingRadius)) {
					collision = true;
					self.postMessage(JSON.stringify({ command: "entity-user collision", data: { position: entComp.position } }));
				}
			});
		}
		e -= 1;
	}
	return collision;
};

self.onmessage = function (event) {

	var message = JSON.parse(event.data),
	    data = message.data,
	    user = observer,
	    voxel = null,
	    toRemove = null,
	    items = [],
	    entities = [],
	    c = 0,
	    p = 0;

	if (message.command == "update") {
		// user.prevPos = [user.position[0], user.position[1], user.position[2]];
		user.position = data.position;
		user.velocity = data.velocity;
		user.vrHeight = data.vrHeight;
		//self.postMessage(JSON.stringify(self.observer));
	} else if (message.command == "add voxels") {
		voxelList = voxelList.concat(data);
		data.map(function (v) {
			voxels[v.cell.join(".")] = v;
		});
	} else if (message.command == "remove voxels") {
		p = data.length - 1;

		while (p >= 0) {
			toRemove = data[p];
			c = voxelList.length - 1;

			while (c >= 0) {
				voxel = voxelList[c];
				if (voxel != null && voxel.cell[0] == toRemove.cell[0] && voxel.cell[1] == toRemove.cell[1] && voxel.cell[2] == toRemove.cell[2]) {
					voxelList.splice(c, 1);
					voxels[voxel.cell.join(".")] = null;
				}
				c--;
			}
			p--;
		}
	} else if (message.command == "add entity") {
		if (!!!voxels[data.coords.join(".")]) voxels[data.coords.join(".")] = { entities: [], cell: data.coords };

		entities = voxels[data.coords.join(".")].entities;
		entities.push(data.entity);
	} else if (message.command == "remove entity") {
		entities = voxels[data.coords.join(".")].entities;
		if (entities != null) {
			c = entities.length - 1;

			while (c >= 0) {
				if (entities[c].id == data.entityId) {
					voxels[data.coords.join(".")].entities.splice(c, 1);
					c = -1;
				}
				c--;
			}
		}
	} else if (message.command == "update entity" || message.command == "update telemetry") {
		if (!data || !data.coords) {
			console.warn("no data to update entity");
			return;
		}
		var cell = data.coords.join(".");
		if (!voxels[cell]) {
			console.warn("can't update entity with no voxel");
			return;
		}
		entities = voxels[cell].entities;

		if (entities != null) {
			c = entities.length - 1;

			while (c >= 0) {
				if (entities[c].id == data.entityId) {
					if (message.command == "update entity") {
						entities[c] = data.entity;
					} else {
						console.info("update telemetry");
						entities[c].position = data.position;
						if (data.quaternion) {
							entities[c].quaternion = data.quaternion;
						}
					}
					c = -1;
				}
				c--;
			}
		}
	} else if (message.command == "clear") {
		voxels = [];
		voxelList = [];
	} else if (message.command == "start") {
		self.update();
	} else if (message.command == "stop") {
		self.stop();
	} else if (message.command == "log") {
		if (data == "") {
			self.postMessage('{"command":"log","data":[' + user.position[0] + ',' + user.position[1] + ',' + user.position[2] + ']}');
			self.postMessage('{"command":"log","data":' + JSON.stringify(voxels) + '}');
		}
	}
};

self.stop = function () {
	clearTimeout(self.updateLoop);
};

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJzcmMvd29ya2Vycy9zdGF0aWMtY29sbGlzaW9ucy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7O0FDQUE7O0FBRUEsSUFBSSxhQUFhLFNBQWIsVUFBYSxDQUFFLENBQUYsRUFBSyxDQUFMLEVBQVk7QUFDekIsUUFBTyxLQUFLLElBQUwsQ0FBVyxLQUFLLEdBQUwsQ0FBVyxFQUFFLENBQUYsSUFBSyxFQUFFLENBQUYsQ0FBaEIsRUFBdUIsQ0FBdkIsSUFBNkIsS0FBSyxHQUFMLENBQVcsRUFBRSxDQUFGLElBQUssRUFBRSxDQUFGLENBQWhCLEVBQXVCLENBQXZCLENBQXhDLENBQVA7QUFDRCxDQUZIO0FBQUEsSUFHRSxvQkFBb0IsU0FBcEIsaUJBQW9CLENBQUUsQ0FBRixFQUFLLENBQUwsRUFBUSxDQUFSLEVBQWU7QUFBRTtBQUNwQyxRQUFPLEtBQUssR0FBTCxDQUFXLEVBQUUsQ0FBRixJQUFLLEVBQUUsQ0FBRixDQUFoQixFQUF1QixDQUF2QixJQUE2QixLQUFLLEdBQUwsQ0FBVyxFQUFFLENBQUYsSUFBSyxFQUFFLENBQUYsQ0FBaEIsRUFBdUIsQ0FBdkIsQ0FBN0IsR0FBMkQsSUFBRSxDQUFwRTtBQUNBLENBTEg7QUFBQSxJQU1FLG9CQUFvQixTQUFwQixpQkFBb0IsQ0FBRSxDQUFGLEVBQUssQ0FBTCxFQUFRLENBQVIsRUFBZTtBQUFFO0FBQ3BDLFFBQVEsS0FBSyxHQUFMLENBQVcsRUFBRSxDQUFGLElBQUssRUFBRSxDQUFGLENBQWhCLEVBQXVCLENBQXZCLElBQTZCLEtBQUssR0FBTCxDQUFXLEVBQUUsQ0FBRixJQUFLLEVBQUUsQ0FBRixDQUFoQixFQUF1QixDQUF2QixDQUE3QixHQUEwRCxLQUFLLEdBQUwsQ0FBVyxFQUFFLENBQUYsSUFBSyxFQUFFLENBQUYsQ0FBaEIsRUFBdUIsQ0FBdkIsQ0FBM0QsR0FBMkYsSUFBRSxDQUFwRztBQUNBLENBUkg7O0FBVUEsSUFBSSxXQUFXO0FBQ2IsV0FBVSxDQUFDLENBQUQsRUFBSSxDQUFKLEVBQU8sQ0FBUCxDQURHO0FBRWIsVUFBUyxDQUFDLENBQUQsRUFBSSxDQUFKLEVBQU8sQ0FBUCxDQUZJO0FBR2IsV0FBVSxDQUFDLENBQUQsRUFBSSxDQUFKLEVBQU8sQ0FBUCxDQUhHO0FBSWIsV0FBVTtBQUpHLENBQWY7QUFBQSxJQU1DLFlBQVksRUFOYjtBQUFBLElBT0MsU0FBUyxFQVBWOztBQVNBLEtBQUssTUFBTCxHQUFjLFlBQU87O0FBRXBCLEtBQUksV0FBVyxDQUFmO0FBQUEsS0FDQyxXQUFhLFNBQVMsUUFEdkI7QUFBQSxLQUVDLFdBQWEsQ0FBQyxLQUFELEVBQVEsS0FBUixDQUZkO0FBQUEsS0FHQyxXQUFhLFNBQVMsUUFIdkI7QUFBQSxLQUlDLFdBQWEsU0FBUyxRQUp2QjtBQUFBLEtBS0MsWUFBYyxLQUxmO0FBQUEsS0FNQyxPQUFVLENBTlg7QUFBQSxLQU9DLFFBQVcsSUFQWjtBQUFBLEtBUUMsTUFBUyxJQVJWO0FBQUEsS0FTQyxZQUFlLEVBVGhCO0FBQUEsS0FVQyxZQUFjLElBVmY7QUFBQSxLQVdDLFNBQVksQ0FBQyxDQUFELEVBQUksQ0FBSixDQVhiO0FBQUEsS0FZQyxRQUFXLElBWlo7QUFBQSxLQWFDLFFBQVcsQ0FBQyxDQUFELEVBQUksQ0FBSixDQWJaO0FBQUEsS0FjQyxPQUFVLEVBZFg7QUFBQSxLQWVDLFFBQVcsQ0FmWjtBQUFBLEtBZ0JDLElBQVEsQ0FoQlQ7QUFBQSxLQWlCQyxJQUFRLENBakJUO0FBQUEsS0FrQkMsSUFBUSxDQWxCVDs7QUFvQkEsTUFBTSxJQUFJLENBQVYsRUFBYSxJQUFJLFVBQVUsTUFBM0IsRUFBbUMsR0FBbkMsRUFBMEM7QUFDekMsVUFBUSxVQUFXLENBQVgsQ0FBUjs7QUFFQSxNQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUgsSUFBWSxDQUFDLENBQUMsQ0FBQyxNQUFNLFFBQTFCLEVBQW9DO0FBQ3BDLE1BQUssQ0FBQyxDQUFDLEtBQUYsSUFBVyxrQkFBbUIsUUFBbkIsRUFBNkIsTUFBTSxRQUFuQyxFQUE2QyxHQUE3QyxDQUFoQixFQUFxRTtBQUFHO0FBQ3ZFLE9BQUssTUFBTSxNQUFOLElBQWdCLFNBQXJCLEVBQWlDO0FBQ2hDLFVBQU0sTUFBTixHQUFlLElBQWY7QUFDQSxTQUFLLFdBQUwsQ0FBaUIsb0RBQWtELE1BQU0sSUFBTixDQUFXLENBQVgsQ0FBbEQsR0FBZ0UsR0FBaEUsR0FBb0UsTUFBTSxJQUFOLENBQVcsQ0FBWCxDQUFwRSxHQUFrRixHQUFsRixHQUFzRixNQUFNLElBQU4sQ0FBVyxDQUFYLENBQXRGLEdBQW9HLEtBQXJIO0FBQ0E7QUFDRCxPQUFLLGtCQUFtQixRQUFuQixFQUE2QixNQUFNLFFBQW5DLEVBQTZDLEVBQTdDLENBQUwsRUFBeUQ7O0FBRXhELFFBQUksTUFBTSxNQUFNLFFBQU4sSUFBa0IsQ0FBNUI7O0FBRUEsV0FBTyxNQUFNLFFBQU4sQ0FBZSxDQUFmLENBQVA7QUFDQSxRQUFLLGtCQUFtQixRQUFuQixFQUE2QixNQUFNLFFBQW5DLEVBQTZDLElBQTdDLENBQUwsRUFBMkQ7QUFDMUQsU0FBSyxTQUFTLENBQVQsSUFBYyxPQUFPLEVBQVAsR0FBWSxRQUExQixJQUF1QyxTQUFTLENBQVQsSUFBYyxRQUFNLElBQU4sSUFBYyxZQUFZLENBQVosR0FBZ0IsV0FBUyxJQUF6QixHQUFnQyxDQUE5QyxDQUExRCxFQUE2RztBQUM1RyxrQkFBWSxJQUFaO0FBQ0EsV0FBSyxXQUFMLENBQWlCLHlFQUF5RSxNQUFNLFFBQU4sQ0FBZSxDQUFmLENBQXpFLEdBQTZGLEdBQTdGLEdBQW1HLElBQW5HLEdBQTBHLEdBQTFHLEdBQWdILE1BQU0sUUFBTixDQUFlLENBQWYsQ0FBaEgsR0FBb0ksTUFBcko7QUFDQTtBQUNEO0FBQ0QsUUFBSyxDQUFDLENBQUMsTUFBTSxRQUFSLElBQW9CLE1BQU0sUUFBTixDQUFlLE1BQWYsR0FBd0IsQ0FBakQsRUFBcUQ7QUFDcEQsaUJBQVksS0FBSyxxQkFBTCxDQUE0QixLQUE1QixFQUFtQyxRQUFuQyxDQUFaO0FBQ0E7QUFDRDtBQUNEO0FBQ0Q7O0FBRUQsS0FBSyxDQUFDLFNBQU4sRUFDQyxTQUFTLE9BQVQsR0FBbUIsQ0FBRSxTQUFTLFFBQVQsQ0FBa0IsQ0FBbEIsQ0FBRixFQUF3QixTQUFTLFFBQVQsQ0FBa0IsQ0FBbEIsQ0FBeEIsRUFBOEMsU0FBUyxRQUFULENBQWtCLENBQWxCLENBQTlDLENBQW5COztBQUVELE1BQUssV0FBTCxDQUFpQix1QkFBakI7QUFDQSxNQUFLLFVBQUwsR0FBa0IsV0FBWSxZQUFNO0FBQ25DLE9BQUssTUFBTDtBQUNBLEVBRmlCLEVBRWYsRUFGZSxDQUFsQjtBQUdBLENBeEREOztBQTBEQSxLQUFLLHFCQUFMLEdBQTZCLFVBQUUsS0FBRixFQUFTLFFBQVQsRUFBdUI7QUFDbkQsS0FBSSxJQUFJLE1BQU0sUUFBTixDQUFlLE1BQWYsR0FBd0IsQ0FBaEM7QUFBQSxLQUNDLE1BQU0sSUFEUDtBQUFBLEtBRUMsWUFBWSxFQUZiO0FBQUEsS0FHQyxZQUFZLEtBSGI7O0FBS0EsUUFBTyxLQUFLLENBQVosRUFBZTtBQUNkLFFBQU0sTUFBTSxRQUFOLENBQWUsQ0FBZixDQUFOO0FBQ0EsY0FBWSxJQUFJLGNBQWhCO0FBQ0EsTUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFILElBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxVQUFyQixFQUFpQztBQUNoQyxXQUFRLElBQVIsQ0FBYSx1QkFBYixFQUFzQyxDQUF0QyxFQUF5QyxHQUF6QyxFQUErQztBQUMvQztBQUNELE1BQUksa0JBQ0gsUUFERyxFQUVILENBQUMsSUFBSSxRQUFKLENBQWEsQ0FBYixJQUFrQixTQUFuQixFQUE4QixJQUFJLFFBQUosQ0FBYSxDQUFiLENBQTlCLEVBQ0EsSUFBSSxRQUFKLENBQWEsQ0FBYixJQUFrQixTQURsQixDQUZHLEVBRzJCLENBQUMsWUFBWSxHQUFaLElBQW1CLENBQXBCLElBQXlCLEdBSHBELENBQUosRUFJRzs7QUFFRixPQUFJLFVBQUosQ0FBZSxHQUFmLENBQW1CLG1CQUFXO0FBQzdCLFFBQUksaUJBQWlCLFFBQVEsY0FBUixHQUF5QixHQUF6QixJQUFnQyxLQUFLLEdBQUwsQ0FBUyxRQUFRLEtBQVIsQ0FBYyxRQUFkLENBQXVCLElBQXZCLENBQTRCLENBQTVCLENBQVQsRUFBeUMsUUFBUSxLQUFSLENBQWMsUUFBZCxDQUF1QixJQUF2QixDQUE0QixDQUE1QixDQUF6QyxJQUEyRSxHQUFoSTs7QUFFQSxRQUFJLENBQUMsQ0FBQyxRQUFRLEtBQVIsQ0FBYyxLQUFwQixFQUEyQjtBQUMxQixTQUFJLGtCQUNILFFBREcsRUFFSCxDQUFDLElBQUksUUFBSixDQUFhLENBQWIsSUFBa0IsUUFBUSxRQUFSLENBQWlCLENBQWpCLENBQW5CLEVBQXdDLENBQXhDLEVBQTJDLElBQUksUUFBSixDQUFhLENBQWIsSUFBa0IsUUFBUSxRQUFSLENBQWlCLENBQWpCLENBQTdELENBRkcsRUFHSCxpQkFBaUIsR0FIZCxDQUFKLEVBSUc7QUFDRixVQUFJLGlCQUFrQixTQUFTLENBQVQsSUFBYyxDQUFkLElBQW1CLFFBQVEsUUFBUixDQUFpQixDQUFqQixJQUFzQixJQUFJLFFBQUosQ0FBYSxDQUFiLENBQXpDLENBQXRCLENBREUsQ0FDZ0Y7QUFDbEYsVUFBSSxpQkFBaUIsQ0FBakIsSUFBc0IsaUJBQWlCLENBQTNDLEVBQThDO0FBQzdDLFlBQUssV0FBTCxDQUFpQixLQUFLLFNBQUwsQ0FBZTtBQUMvQixpQkFBUyxpQkFEc0IsRUFDSCxNQUFNO0FBQ2pDLG1CQUFVLFFBQVEsUUFEZTtBQUVqQyxvQkFBVyxRQUFRLEtBQVIsQ0FBYztBQUZRO0FBREgsUUFBZixDQUFqQjtBQU1BLG1CQUFZLElBQVo7QUFDQTtBQUNEO0FBQ0QsS0FqQkQsTUFpQk8sSUFBSSxrQkFDVixRQURVLEVBRVYsQ0FBQyxJQUFJLFFBQUosQ0FBYSxDQUFiLElBQWtCLFFBQVEsUUFBUixDQUFpQixDQUFqQixDQUFuQixFQUF3QyxJQUFJLFFBQUosQ0FBYSxDQUFiLElBQWtCLFFBQVEsUUFBUixDQUFpQixDQUFqQixDQUExRCxFQUErRSxJQUFJLFFBQUosQ0FBYSxDQUFiLElBQWtCLFFBQVEsUUFBUixDQUFpQixDQUFqQixDQUFqRyxDQUZVLEVBR1YsY0FIVSxDQUFKLEVBSUo7QUFDRixpQkFBWSxJQUFaO0FBQ0EsVUFBSyxXQUFMLENBQWlCLEtBQUssU0FBTCxDQUFlLEVBQUUsU0FBUyx1QkFBWCxFQUFvQyxNQUFNLEVBQUUsVUFBVSxRQUFRLFFBQXBCLEVBQTFDLEVBQWYsQ0FBakI7QUFDQTtBQUVELElBN0JEO0FBOEJBO0FBQ0QsT0FBSyxDQUFMO0FBQ0E7QUFDRCxRQUFPLFNBQVA7QUFDQSxDQXBERDs7QUFzREEsS0FBSyxTQUFMLEdBQWlCLFVBQUUsS0FBRixFQUFhOztBQUU3QixLQUFJLFVBQVcsS0FBSyxLQUFMLENBQVksTUFBTSxJQUFsQixDQUFmO0FBQUEsS0FDQyxPQUFTLFFBQVEsSUFEbEI7QUFBQSxLQUVDLE9BQVMsUUFGVjtBQUFBLEtBR0MsUUFBVSxJQUhYO0FBQUEsS0FJQyxXQUFXLElBSlo7QUFBQSxLQUtDLFFBQVUsRUFMWDtBQUFBLEtBTUMsV0FBVyxFQU5aO0FBQUEsS0FPQyxJQUFPLENBUFI7QUFBQSxLQVFDLElBQU8sQ0FSUjs7QUFVQSxLQUFLLFFBQVEsT0FBUixJQUFtQixRQUF4QixFQUFtQztBQUNsQztBQUNBLE9BQUssUUFBTCxHQUFnQixLQUFLLFFBQXJCO0FBQ0EsT0FBSyxRQUFMLEdBQWdCLEtBQUssUUFBckI7QUFDQSxPQUFLLFFBQUwsR0FBZ0IsS0FBSyxRQUFyQjtBQUNBO0FBQ0EsRUFORCxNQU1PLElBQUssUUFBUSxPQUFSLElBQW1CLFlBQXhCLEVBQXVDO0FBQzdDLGNBQVksVUFBVSxNQUFWLENBQWlCLElBQWpCLENBQVo7QUFDQSxPQUFLLEdBQUwsQ0FBVSxhQUFLO0FBQ2QsVUFBUSxFQUFFLElBQUYsQ0FBTyxJQUFQLENBQVksR0FBWixDQUFSLElBQTZCLENBQTdCO0FBQ0EsR0FGRDtBQUdBLEVBTE0sTUFLQSxJQUFLLFFBQVEsT0FBUixJQUFtQixlQUF4QixFQUEwQztBQUNoRCxNQUFJLEtBQUssTUFBTCxHQUFhLENBQWpCOztBQUVBLFNBQVEsS0FBSyxDQUFiLEVBQWlCO0FBQ2hCLGNBQVcsS0FBSyxDQUFMLENBQVg7QUFDQSxPQUFJLFVBQVUsTUFBVixHQUFpQixDQUFyQjs7QUFFQSxVQUFRLEtBQUssQ0FBYixFQUFpQjtBQUNoQixZQUFRLFVBQVcsQ0FBWCxDQUFSO0FBQ0EsUUFBSyxTQUFTLElBQVQsSUFBaUIsTUFBTSxJQUFOLENBQVcsQ0FBWCxLQUFpQixTQUFTLElBQVQsQ0FBYyxDQUFkLENBQWxDLElBQXNELE1BQU0sSUFBTixDQUFXLENBQVgsS0FBaUIsU0FBUyxJQUFULENBQWMsQ0FBZCxDQUF2RSxJQUE0RixNQUFNLElBQU4sQ0FBVyxDQUFYLEtBQWlCLFNBQVMsSUFBVCxDQUFjLENBQWQsQ0FBbEgsRUFBcUk7QUFDcEksZUFBVSxNQUFWLENBQWtCLENBQWxCLEVBQXFCLENBQXJCO0FBQ0EsWUFBUSxNQUFNLElBQU4sQ0FBVyxJQUFYLENBQWdCLEdBQWhCLENBQVIsSUFBZ0MsSUFBaEM7QUFDQTtBQUNEO0FBQ0E7QUFDRDtBQUNBO0FBQ0QsRUFqQk0sTUFpQkEsSUFBSyxRQUFRLE9BQVIsSUFBbUIsWUFBeEIsRUFBdUM7QUFDN0MsTUFBSSxDQUFDLENBQUMsQ0FBRSxPQUFPLEtBQUssTUFBTCxDQUFZLElBQVosQ0FBaUIsR0FBakIsQ0FBUCxDQUFSLEVBQ0MsT0FBTyxLQUFLLE1BQUwsQ0FBWSxJQUFaLENBQWlCLEdBQWpCLENBQVAsSUFBZ0MsRUFBRSxVQUFVLEVBQVosRUFBZ0IsTUFBTSxLQUFLLE1BQTNCLEVBQWhDOztBQUVFLGFBQVcsT0FBTyxLQUFLLE1BQUwsQ0FBWSxJQUFaLENBQWlCLEdBQWpCLENBQVAsRUFBOEIsUUFBekM7QUFDQSxXQUFTLElBQVQsQ0FBZSxLQUFLLE1BQXBCO0FBQ0QsRUFOSSxNQU1FLElBQUssUUFBUSxPQUFSLElBQW1CLGVBQXhCLEVBQTBDO0FBQy9DLGFBQVcsT0FBUSxLQUFLLE1BQUwsQ0FBWSxJQUFaLENBQWlCLEdBQWpCLENBQVIsRUFBZ0MsUUFBM0M7QUFDSCxNQUFLLFlBQVksSUFBakIsRUFBd0I7QUFDdkIsT0FBSSxTQUFTLE1BQVQsR0FBZ0IsQ0FBcEI7O0FBRUEsVUFBUSxLQUFLLENBQWIsRUFBaUI7QUFDaEIsUUFBSyxTQUFTLENBQVQsRUFBWSxFQUFaLElBQWtCLEtBQUssUUFBNUIsRUFBdUM7QUFDdEMsWUFBUSxLQUFLLE1BQUwsQ0FBWSxJQUFaLENBQWlCLEdBQWpCLENBQVIsRUFBZ0MsUUFBaEMsQ0FBeUMsTUFBekMsQ0FBZ0QsQ0FBaEQsRUFBbUQsQ0FBbkQ7QUFDQSxTQUFJLENBQUMsQ0FBTDtBQUNBO0FBQ0Q7QUFDQTtBQUNEO0FBQ0QsRUFiUSxNQWFGLElBQUssUUFBUSxPQUFSLElBQW1CLGVBQW5CLElBQXNDLFFBQVEsT0FBUixJQUFtQixrQkFBOUQsRUFBbUY7QUFDekYsTUFBSSxDQUFDLElBQUQsSUFBUyxDQUFDLEtBQUssTUFBbkIsRUFBMkI7QUFDMUIsV0FBUSxJQUFSLENBQWEsMEJBQWI7QUFDQTtBQUNBO0FBQ0QsTUFBSSxPQUFRLEtBQUssTUFBTCxDQUFZLElBQVosQ0FBaUIsR0FBakIsQ0FBWjtBQUNBLE1BQUssQ0FBQyxPQUFPLElBQVAsQ0FBTixFQUFxQjtBQUNwQixXQUFRLElBQVIsQ0FBYSxtQ0FBYjtBQUNBO0FBQ0E7QUFDRCxhQUFXLE9BQVEsSUFBUixFQUFlLFFBQTFCOztBQUVBLE1BQUssWUFBWSxJQUFqQixFQUF3QjtBQUN2QixPQUFJLFNBQVMsTUFBVCxHQUFnQixDQUFwQjs7QUFFQSxVQUFRLEtBQUssQ0FBYixFQUFpQjtBQUNoQixRQUFJLFNBQVUsQ0FBVixFQUFjLEVBQWQsSUFBb0IsS0FBSyxRQUE3QixFQUF1QztBQUN0QyxTQUFLLFFBQVEsT0FBUixJQUFtQixlQUF4QixFQUEwQztBQUN6QyxlQUFVLENBQVYsSUFBZ0IsS0FBSyxNQUFyQjtBQUNBLE1BRkQsTUFFTztBQUNOLGNBQVEsSUFBUixDQUFhLGtCQUFiO0FBQ0EsZUFBVSxDQUFWLEVBQWMsUUFBZCxHQUF5QixLQUFLLFFBQTlCO0FBQ0EsVUFBSyxLQUFLLFVBQVYsRUFBdUI7QUFDdEIsZ0JBQVUsQ0FBVixFQUFjLFVBQWQsR0FBMkIsS0FBSyxVQUFoQztBQUNBO0FBQ0Q7QUFDRCxTQUFJLENBQUMsQ0FBTDtBQUNBO0FBQ0Q7QUFDQTtBQUNEO0FBQ0QsRUEvQk0sTUErQkEsSUFBSyxRQUFRLE9BQVIsSUFBbUIsT0FBeEIsRUFBa0M7QUFDeEMsV0FBUyxFQUFUO0FBQ0EsY0FBWSxFQUFaO0FBQ0EsRUFITSxNQUdBLElBQUssUUFBUSxPQUFSLElBQW1CLE9BQXhCLEVBQWtDO0FBQ3hDLE9BQUssTUFBTDtBQUNBLEVBRk0sTUFFQSxJQUFLLFFBQVEsT0FBUixJQUFtQixNQUF4QixFQUFpQztBQUN2QyxPQUFLLElBQUw7QUFDQSxFQUZNLE1BRUEsSUFBSyxRQUFRLE9BQVIsSUFBbUIsS0FBeEIsRUFBZ0M7QUFDdEMsTUFBSSxRQUFRLEVBQVosRUFBZ0I7QUFDZixRQUFLLFdBQUwsQ0FBaUIsOEJBQThCLEtBQUssUUFBTCxDQUFjLENBQWQsQ0FBOUIsR0FBaUQsR0FBakQsR0FBdUQsS0FBSyxRQUFMLENBQWMsQ0FBZCxDQUF2RCxHQUEwRSxHQUExRSxHQUFnRixLQUFLLFFBQUwsQ0FBYyxDQUFkLENBQWhGLEdBQW1HLElBQXBIO0FBQ0EsUUFBSyxXQUFMLENBQWlCLDZCQUE2QixLQUFLLFNBQUwsQ0FBZSxNQUFmLENBQTdCLEdBQXFELEdBQXRFO0FBQ0E7QUFDRDtBQUNELENBdkdEOztBQXlHQSxLQUFLLElBQUwsR0FBWSxZQUFNO0FBQ2pCLGNBQWMsS0FBSyxVQUFuQjtBQUNBLENBRkQiLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiBlKHQsbixyKXtmdW5jdGlvbiBzKG8sdSl7aWYoIW5bb10pe2lmKCF0W29dKXt2YXIgYT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbW9kdWxlICdcIitvK1wiJ1wiKTt0aHJvdyBmLmNvZGU9XCJNT0RVTEVfTk9UX0ZPVU5EXCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pIiwiLyogIHN0YXRpYyBjb2xsaXNpb24gZGV0ZWN0aW9uIHdvcmtlciAqL1xuXG5sZXQgZGlzdGFuY2UyZCA9ICggYSwgYiApID0+IHtcbiAgICByZXR1cm4gTWF0aC5zcXJ0KCBNYXRoLnBvdyggKGFbMF0tYlswXSksIDIgKSArIE1hdGgucG93KCAoYVsyXS1iWzJdKSwgMiApIClcbiAgfSxcbiAgZGlzdGFuY2UyZENvbXBhcmUgPSAoIGEsIGIsIG4gKSA9PiB7IC8vIG1vcmUgZWZmaWNpZW50IHZlcnNpb24gb2YgZGlzdGFuY2UyZCgpXG5cdCAgcmV0dXJuIE1hdGgucG93KCAoYVswXS1iWzBdKSwgMiApICsgTWF0aC5wb3coIChhWzJdLWJbMl0pLCAyICkgPCAobipuKVxuICB9LFxuICBkaXN0YW5jZTNkQ29tcGFyZSA9ICggYSwgYiwgbiApID0+IHsgLy8gLi5mYXN0ZXIgdGhhbiB1c2luZyBNYXRoLnNxcnQoKVxuXHQgIHJldHVybiAoTWF0aC5wb3coIChhWzBdLWJbMF0pLCAyICkgKyBNYXRoLnBvdyggKGFbMV0tYlsxXSksIDIgKSArIE1hdGgucG93KCAoYVsyXS1iWzJdKSwgMiApICkgPCAobipuKVxuICB9XG5cbmxldCBvYnNlcnZlciA9IHtcblx0XHRwb3NpdGlvbjogWzAsIDAsIDBdLFxuXHRcdHByZXZQb3M6IFswLCAwLCAwXSxcblx0XHR2ZWxvY2l0eTogWzAsIDAsIDBdLFxuXHRcdHZySGVpZ2h0OiAxLjY2XG5cdH0sXG5cdHZveGVsTGlzdCA9IFtdLFxuXHR2b3hlbHMgPSBbXVxuXG5zZWxmLnVwZGF0ZSA9ICggKSA9PiB7XG5cblx0dmFyIGRpc3RhbmNlID0gMCxcblx0XHRwb3NpdGlvbiBcdCA9IG9ic2VydmVyLnBvc2l0aW9uLFxuXHRcdGlubmVyQm94IFx0ID0gW2ZhbHNlLCBmYWxzZV0sXG5cdFx0dmVsb2NpdHkgXHQgPSBvYnNlcnZlci52ZWxvY2l0eSxcblx0XHR2ckhlaWdodCBcdCA9IG9ic2VydmVyLnZySGVpZ2h0LFxuXHRcdGNvbGxpc2lvbiBcdCA9IGZhbHNlLFxuXHRcdHlQb3MgXHRcdCA9IDAsXG5cdFx0dm94ZWwgXHRcdCA9IG51bGwsXG5cdFx0ZW50IFx0XHQgPSBudWxsLFxuXHRcdGVudFJhZGl1cyAgICA9IDEwLFxuXHRcdHN0cnVjdHVyZSBcdCA9IG51bGwsXG5cdFx0Ym91bmRzIFx0XHQgPSBbMCwgMF0sXG5cdFx0dm94ZWwgXHRcdCA9IG51bGwsXG5cdFx0ZGVsdGEgXHRcdCA9IFswLCAwXSxcblx0XHRvUG9zIFx0XHQgPSBbXSxcblx0XHRzcGVlZCBcdFx0ID0gMCxcblx0XHRlIFx0XHRcdCA9IDAsXG5cdFx0aSBcdFx0XHQgPSAwLFxuXHRcdHYgXHRcdFx0ID0gMFxuXG5cdGZvciAoIGkgPSAwOyBpIDwgdm94ZWxMaXN0Lmxlbmd0aDsgaSArKyApIHtcblx0XHR2b3hlbCA9IHZveGVsTGlzdFsgaSBdXG5cblx0XHRpZiAoICEhIXZveGVsIHx8ICEhIXZveGVsLnBvc2l0aW9uKSBjb250aW51ZVxuXHRcdGlmICggISF2b3hlbCAmJiBkaXN0YW5jZTJkQ29tcGFyZSggcG9zaXRpb24sIHZveGVsLnBvc2l0aW9uLCAxODAgKSApIHsgXHQvLyBkbyBjb2xsaXNpb25zIG9uIHZveGVscyAmIHN0cnVjdHVyZXMuLi4ganVzdCB3YWxscyBhdCBmaXJzdC4uXHRcdFxuXHRcdFx0aWYgKCB2b3hlbC5sb2FkZWQgPT0gdW5kZWZpbmVkICkge1xuXHRcdFx0XHR2b3hlbC5sb2FkZWQgPSB0cnVlXG5cdFx0XHRcdHNlbGYucG9zdE1lc3NhZ2UoJ3tcImNvbW1hbmRcIjogXCJsb2FkIGVudGl0aWVzXCIsIFwiZGF0YVwiOntcImNvb3Jkc1wiOlwiJyt2b3hlbC5jZWxsWzBdKycuJyt2b3hlbC5jZWxsWzFdKycuJyt2b3hlbC5jZWxsWzJdKydcIn19Jyk7XG5cdFx0XHR9XG5cdFx0XHRpZiAoIGRpc3RhbmNlMmRDb21wYXJlKCBwb3NpdGlvbiwgdm94ZWwucG9zaXRpb24sIDYwICkgKSB7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdGxldCBhbHQgPSB2b3hlbC5hbHRpdHVkZSB8fCAwXG5cdFx0XHRcdFxuXHRcdFx0XHR5UG9zID0gdm94ZWwucG9zaXRpb25bMV1cblx0XHRcdFx0aWYgKCBkaXN0YW5jZTJkQ29tcGFyZSggcG9zaXRpb24sIHZveGVsLnBvc2l0aW9uLCAyNC41ICkgKSB7XG5cdFx0XHRcdFx0aWYgKCBwb3NpdGlvblsxXSA+IHlQb3MgLSAyMSArIHZySGVpZ2h0ICAmJiBwb3NpdGlvblsxXSA8IDE0LjI1K3lQb3MgKyAodnJIZWlnaHQgIT0gMCA/IHZySGVpZ2h0KzAuMjUgOiAwKSApIHtcblx0XHRcdFx0XHRcdGNvbGxpc2lvbiA9IHRydWVcblx0XHRcdFx0XHRcdHNlbGYucG9zdE1lc3NhZ2UoJ3tcImNvbW1hbmRcIjogXCJwbGF0Zm9ybSBjb2xsaXNpb25cIiwgXCJkYXRhXCI6e1widHlwZVwiOlwidG9wXCIsIFwicG9zaXRpb25cIjpbJyArIHZveGVsLnBvc2l0aW9uWzBdICsgJywnICsgeVBvcyArICcsJyArIHZveGVsLnBvc2l0aW9uWzJdICsgJ10gfX0nKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cdFxuXHRcdFx0XHRpZiAoICEhdm94ZWwuZW50aXRpZXMgJiYgdm94ZWwuZW50aXRpZXMubGVuZ3RoID4gMCApIHtcblx0XHRcdFx0XHRjb2xsaXNpb24gPSBzZWxmLmNoZWNrU3RhdGljQ29sbGlzaW9ucyggdm94ZWwsIHBvc2l0aW9uIClcblx0XHRcdFx0fVx0XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0aWYgKCAhY29sbGlzaW9uIClcblx0XHRvYnNlcnZlci5wcmV2UG9zID0gWyBvYnNlcnZlci5wb3NpdGlvblswXSwgb2JzZXJ2ZXIucG9zaXRpb25bMV0sIG9ic2VydmVyLnBvc2l0aW9uWzJdIF1cblx0XG5cdHNlbGYucG9zdE1lc3NhZ2UoJ3tcImNvbW1hbmRcIjogXCJ1cGRhdGVcIn0nKVxuXHRzZWxmLnVwZGF0ZUxvb3AgPSBzZXRUaW1lb3V0KCAoKSA9PiB7XG5cdFx0c2VsZi51cGRhdGUoKVxuXHR9LCAxNSlcbn1cblxuc2VsZi5jaGVja1N0YXRpY0NvbGxpc2lvbnMgPSAoIHZveGVsLCBwb3NpdGlvbiApID0+IHtcblx0bGV0IGUgPSB2b3hlbC5lbnRpdGllcy5sZW5ndGggLSAxLFxuXHRcdGVudCA9IG51bGwsXG5cdFx0ZW50UmFkaXVzID0gMTAsXG5cdFx0Y29sbGlzaW9uID0gZmFsc2VcblxuXHR3aGlsZSAoZSA+PSAwKSB7XG5cdFx0ZW50ID0gdm94ZWwuZW50aXRpZXNbZV1cblx0XHRlbnRSYWRpdXMgPSBlbnQuYm91bmRpbmdSYWRpdXNcblx0XHRpZiAoISEhZW50IHx8ICEhIWVudC5jb21wb25lbnRzKSB7XG5cdFx0XHRjb25zb2xlLndhcm4oXCJQcm9ibGVtIHdpdGggZW50aXR5ISBcIiwgZSwgZW50KTsgY29udGludWVcblx0XHR9XG5cdFx0aWYgKGRpc3RhbmNlM2RDb21wYXJlKFxuXHRcdFx0cG9zaXRpb24sXG5cdFx0XHRbZW50LnBvc2l0aW9uWzBdIC0gZW50UmFkaXVzLCBlbnQucG9zaXRpb25bMV0sXG5cdFx0XHRlbnQucG9zaXRpb25bMl0gLSBlbnRSYWRpdXNdLCAoZW50UmFkaXVzICogMS42IHx8IDMpICsgMi41XG5cdFx0KSkge1xuXG5cdFx0XHRlbnQuY29tcG9uZW50cy5tYXAoZW50Q29tcCA9PiB7XG5cdFx0XHRcdGxldCBib3VuZGluZ1JhZGl1cyA9IGVudENvbXAuYm91bmRpbmdSYWRpdXMgKiAxLjIgfHwgTWF0aC5tYXgoZW50Q29tcC5wcm9wcy5nZW9tZXRyeS5zaXplWzBdLCBlbnRDb21wLnByb3BzLmdlb21ldHJ5LnNpemVbMl0pICogMS40XG5cblx0XHRcdFx0aWYgKCEhZW50Q29tcC5wcm9wcy5mbG9vcikge1xuXHRcdFx0XHRcdGlmIChkaXN0YW5jZTJkQ29tcGFyZShcblx0XHRcdFx0XHRcdHBvc2l0aW9uLFxuXHRcdFx0XHRcdFx0W2VudC5wb3NpdGlvblswXSArIGVudENvbXAucG9zaXRpb25bMF0sIDAsIGVudC5wb3NpdGlvblsyXSArIGVudENvbXAucG9zaXRpb25bMl1dLFxuXHRcdFx0XHRcdFx0Ym91bmRpbmdSYWRpdXMgKiAyLjJcblx0XHRcdFx0XHQpKSB7XG5cdFx0XHRcdFx0XHRsZXQgdmVydGljYWxPZmZzZXQgPSAocG9zaXRpb25bMV0gKyAyIC0gKGVudENvbXAucG9zaXRpb25bMV0gKyBlbnQucG9zaXRpb25bMV0gKSkgLy8gICsgZW50Q29tcC5nZW9tZXRyeSA/IGVudENvbXAuZ2VvbWV0cnkuc2l6ZVsxXSA6IDFcblx0XHRcdFx0XHRcdGlmICh2ZXJ0aWNhbE9mZnNldCA+IDAgJiYgdmVydGljYWxPZmZzZXQgPCA1KSB7XG5cdFx0XHRcdFx0XHRcdHNlbGYucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoe1xuXHRcdFx0XHRcdFx0XHRcdGNvbW1hbmQ6IFwiZmxvb3IgY29sbGlzaW9uXCIsIGRhdGE6IHtcblx0XHRcdFx0XHRcdFx0XHRcdHBvc2l0aW9uOiBlbnRDb21wLnBvc2l0aW9uLFxuXHRcdFx0XHRcdFx0XHRcdFx0Zmxvb3JEYXRhOiBlbnRDb21wLnByb3BzLmZsb29yXG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHR9KSlcblx0XHRcdFx0XHRcdFx0Y29sbGlzaW9uID0gdHJ1ZVxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBlbHNlIGlmIChkaXN0YW5jZTNkQ29tcGFyZShcblx0XHRcdFx0XHRwb3NpdGlvbixcblx0XHRcdFx0XHRbZW50LnBvc2l0aW9uWzBdICsgZW50Q29tcC5wb3NpdGlvblswXSwgZW50LnBvc2l0aW9uWzFdICsgZW50Q29tcC5wb3NpdGlvblsxXSwgZW50LnBvc2l0aW9uWzJdICsgZW50Q29tcC5wb3NpdGlvblsyXV0sXG5cdFx0XHRcdFx0Ym91bmRpbmdSYWRpdXNcblx0XHRcdFx0KSkge1xuXHRcdFx0XHRcdGNvbGxpc2lvbiA9IHRydWVcblx0XHRcdFx0XHRzZWxmLnBvc3RNZXNzYWdlKEpTT04uc3RyaW5naWZ5KHsgY29tbWFuZDogXCJlbnRpdHktdXNlciBjb2xsaXNpb25cIiwgZGF0YTogeyBwb3NpdGlvbjogZW50Q29tcC5wb3NpdGlvbiB9IH0pKVxuXHRcdFx0XHR9XG5cblx0XHRcdH0pXG5cdFx0fVxuXHRcdGUgLT0gMVxuXHR9XG5cdHJldHVybiBjb2xsaXNpb25cbn1cblxuc2VsZi5vbm1lc3NhZ2UgPSAoIGV2ZW50ICkgPT4geyBcblxuXHR2YXIgbWVzc2FnZSAgPSBKU09OLnBhcnNlKCBldmVudC5kYXRhICksXG5cdFx0ZGF0YSBcdCA9IG1lc3NhZ2UuZGF0YSxcblx0XHR1c2VyIFx0ID0gb2JzZXJ2ZXIsXG5cdFx0dm94ZWwgXHQgPSBudWxsLFxuXHRcdHRvUmVtb3ZlID0gbnVsbCxcblx0XHRpdGVtcyBcdCA9IFtdLFxuXHRcdGVudGl0aWVzID0gW10sXG5cdFx0YyBcdFx0ID0gMCxcblx0XHRwIFx0XHQgPSAwXG5cdFx0XG5cdGlmICggbWVzc2FnZS5jb21tYW5kID09IFwidXBkYXRlXCIgKSB7XG5cdFx0Ly8gdXNlci5wcmV2UG9zID0gW3VzZXIucG9zaXRpb25bMF0sIHVzZXIucG9zaXRpb25bMV0sIHVzZXIucG9zaXRpb25bMl1dO1xuXHRcdHVzZXIucG9zaXRpb24gPSBkYXRhLnBvc2l0aW9uXG5cdFx0dXNlci52ZWxvY2l0eSA9IGRhdGEudmVsb2NpdHlcblx0XHR1c2VyLnZySGVpZ2h0ID0gZGF0YS52ckhlaWdodFxuXHRcdC8vc2VsZi5wb3N0TWVzc2FnZShKU09OLnN0cmluZ2lmeShzZWxmLm9ic2VydmVyKSk7XG5cdH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcImFkZCB2b3hlbHNcIiApIHtcblx0XHR2b3hlbExpc3QgPSB2b3hlbExpc3QuY29uY2F0KGRhdGEpXG5cdFx0ZGF0YS5tYXAoIHYgPT4ge1xuXHRcdFx0dm94ZWxzWyB2LmNlbGwuam9pbihcIi5cIikgXSA9IHZcblx0XHR9KVxuXHR9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJyZW1vdmUgdm94ZWxzXCIgKSB7XG5cdFx0cCA9IGRhdGEubGVuZ3RoIC0xXG5cdFxuXHRcdHdoaWxlICggcCA+PSAwICkge1xuXHRcdFx0dG9SZW1vdmUgPSBkYXRhW3BdXG5cdFx0XHRjID0gdm94ZWxMaXN0Lmxlbmd0aC0xXG5cdFx0XHRcblx0XHRcdHdoaWxlICggYyA+PSAwICkge1xuXHRcdFx0XHR2b3hlbCA9IHZveGVsTGlzdFsgYyBdXG5cdFx0XHRcdGlmICggdm94ZWwgIT0gbnVsbCAmJiB2b3hlbC5jZWxsWzBdID09IHRvUmVtb3ZlLmNlbGxbMF0gJiYgdm94ZWwuY2VsbFsxXSA9PSB0b1JlbW92ZS5jZWxsWzFdICAmJiB2b3hlbC5jZWxsWzJdID09IHRvUmVtb3ZlLmNlbGxbMl0gKSB7XHRcblx0XHRcdFx0XHR2b3hlbExpc3Quc3BsaWNlKCBjLCAxIClcblx0XHRcdFx0XHR2b3hlbHNbIHZveGVsLmNlbGwuam9pbihcIi5cIildID0gbnVsbFxuXHRcdFx0XHR9XG5cdFx0XHRcdGMtLVxuXHRcdFx0fVxuXHRcdFx0cCAtLVxuXHRcdH1cblx0fSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwiYWRkIGVudGl0eVwiICkge1xuXHRcdGlmICghISEgdm94ZWxzW2RhdGEuY29vcmRzLmpvaW4oXCIuXCIpXSlcblx0XHRcdHZveGVsc1tkYXRhLmNvb3Jkcy5qb2luKFwiLlwiKV0gPSB7IGVudGl0aWVzOiBbXSwgY2VsbDogZGF0YS5jb29yZHMgfVxuXG4gICAgXHRlbnRpdGllcyA9IHZveGVsc1tkYXRhLmNvb3Jkcy5qb2luKFwiLlwiKV0uZW50aXRpZXNcbiAgICBcdGVudGl0aWVzLnB1c2goIGRhdGEuZW50aXR5IClcbiAgXHR9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJyZW1vdmUgZW50aXR5XCIgKSB7XG4gICAgXHRlbnRpdGllcyA9IHZveGVsc1sgZGF0YS5jb29yZHMuam9pbihcIi5cIikgXS5lbnRpdGllc1xuXHRcdGlmICggZW50aXRpZXMgIT0gbnVsbCApIHtcblx0XHRcdGMgPSBlbnRpdGllcy5sZW5ndGgtMVxuXHRcdFx0XG5cdFx0XHR3aGlsZSAoIGMgPj0gMCApIHtcblx0XHRcdFx0aWYgKCBlbnRpdGllc1tjXS5pZCA9PSBkYXRhLmVudGl0eUlkICkge1xuXHRcdFx0XHRcdHZveGVsc1sgZGF0YS5jb29yZHMuam9pbihcIi5cIikgXS5lbnRpdGllcy5zcGxpY2UoYywgMSlcblx0XHRcdFx0XHRjID0gLTFcblx0XHRcdFx0fVxuXHRcdFx0XHRjLS1cblx0XHRcdH1cblx0XHR9XG5cdH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcInVwZGF0ZSBlbnRpdHlcIiB8fCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJ1cGRhdGUgdGVsZW1ldHJ5XCIgKSB7XG5cdFx0aWYgKCFkYXRhIHx8ICFkYXRhLmNvb3Jkcykge1xuXHRcdFx0Y29uc29sZS53YXJuKFwibm8gZGF0YSB0byB1cGRhdGUgZW50aXR5XCIpXG5cdFx0XHRyZXR1cm5cblx0XHR9XG5cdFx0bGV0IGNlbGwgPSAgZGF0YS5jb29yZHMuam9pbihcIi5cIilcblx0XHRpZiAoICF2b3hlbHNbY2VsbF0gKSB7XG5cdFx0XHRjb25zb2xlLndhcm4oXCJjYW4ndCB1cGRhdGUgZW50aXR5IHdpdGggbm8gdm94ZWxcIilcblx0XHRcdHJldHVyblxuXHRcdH1cblx0XHRlbnRpdGllcyA9IHZveGVsc1sgY2VsbCBdLmVudGl0aWVzXG5cblx0XHRpZiAoIGVudGl0aWVzICE9IG51bGwgKSB7XG5cdFx0XHRjID0gZW50aXRpZXMubGVuZ3RoLTFcblxuXHRcdFx0d2hpbGUgKCBjID49IDAgKSB7XG5cdFx0XHRcdGlmIChlbnRpdGllc1sgYyBdLmlkID09IGRhdGEuZW50aXR5SWQpIHtcblx0XHRcdFx0XHRpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcInVwZGF0ZSBlbnRpdHlcIiApIHtcblx0XHRcdFx0XHRcdGVudGl0aWVzWyBjIF0gPSBkYXRhLmVudGl0eVxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmluZm8oXCJ1cGRhdGUgdGVsZW1ldHJ5XCIpXG5cdFx0XHRcdFx0XHRlbnRpdGllc1sgYyBdLnBvc2l0aW9uID0gZGF0YS5wb3NpdGlvblxuXHRcdFx0XHRcdFx0aWYgKCBkYXRhLnF1YXRlcm5pb24gKSB7XG5cdFx0XHRcdFx0XHRcdGVudGl0aWVzWyBjIF0ucXVhdGVybmlvbiA9IGRhdGEucXVhdGVybmlvbjtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XHRcdFx0XHRcdFxuXHRcdFx0XHRcdGMgPSAtMVxuXHRcdFx0XHR9XG5cdFx0XHRcdGMtLVxuXHRcdFx0fVxuXHRcdH1cblx0fSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwiY2xlYXJcIiApIHtcblx0XHR2b3hlbHMgPSBbXVxuXHRcdHZveGVsTGlzdCA9IFtdXG5cdH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcInN0YXJ0XCIgKSB7XG5cdFx0c2VsZi51cGRhdGUoKVxuXHR9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJzdG9wXCIgKSB7XG5cdFx0c2VsZi5zdG9wKClcblx0fSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwibG9nXCIgKSB7XG5cdFx0aWYgKGRhdGEgPT0gXCJcIikge1xuXHRcdFx0c2VsZi5wb3N0TWVzc2FnZSgne1wiY29tbWFuZFwiOlwibG9nXCIsXCJkYXRhXCI6WycgKyB1c2VyLnBvc2l0aW9uWzBdICsgJywnICsgdXNlci5wb3NpdGlvblsxXSArICcsJyArIHVzZXIucG9zaXRpb25bMl0gKyAnXX0nKTtcblx0XHRcdHNlbGYucG9zdE1lc3NhZ2UoJ3tcImNvbW1hbmRcIjpcImxvZ1wiLFwiZGF0YVwiOicgKyBKU09OLnN0cmluZ2lmeSh2b3hlbHMpKyAnfScpO1xuXHRcdH1cblx0fVxufTtcblxuc2VsZi5zdG9wID0gKCkgPT4ge1xuXHRjbGVhclRpbWVvdXQoIHNlbGYudXBkYXRlTG9vcCApXG59XG4iXX0=
