(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
/* entity worker */
// collisions btween entities in motion and other entities
"use strict";

var distance2d = function (a, b) {

  return Math.sqrt(Math.pow(a[0] - b[0], 2) + Math.pow(a[2] - b[2], 2));
},
    distance2dCompare = function (a, b, n) {
  // more efficient version of distance2d()

  return Math.pow(a[0] - b[0], 2) + Math.pow(a[2] - b[2], 2) < n * n;
},
    distance3dCompare = function (a, b, n) {
  // ..faster than using Math.sqrt()

  return Math.pow(a[0] - b[0], 2) + Math.pow(a[1] - b[1], 2) + Math.pow(a[2] - b[2], 2) < n * n;
};

var voxelList = [],
    voxels = {},
    // map of string coordinates to arrays of entities
observer = {
  position: [0, 0, 0],
  prevPos: [0, 0, 0],
  velocity: [0, 0, 0],
  hands: [],
  vrHeight: 1.66
};

self.onmessage = function (event) {
  // probably going to replace most of this worker with Cannon.js.. & can fallback to static-collision worker in most cases

  var message = JSON.parse(event.data),
      data = message.data,
      entities = [],
      toRemove = null,
      voxel = null,
      user = observer,
      c = 0;

  if (message.command == "set in motion") {} else if (message.command == "become static") {} else if (message.command == "add voxels") {

    voxelList = voxelList.concat(data);

    data.map(function (v) {

      voxels[v.cell.join(".")] = v;
    });
  } else if (message.command == "remove voxels") {

    c = data.length - 1;

    while (c >= 0) {

      toRemove = data[c];
      voxelList.splice(voxelList.indexOf(voxels[toRemove.cell]), 1);
      voxels[toRemove.cell] = null;
      c--;
    }
  } else if (message.command == "add entity") {

    entities = voxels[data.coords.join(".")].entities;

    if (entities != null) {

      voxels[data.coords.join("x")].entities.push(data.entity);
    }
  } else if (message.command == "remove entity") {

    entities = voxels[data.coords.join(".")].entities;

    if (entities != null) {

      c = entities.length - 1;

      while (c >= 0) {

        if (entities[c].id == data.entityId) {

          voxels[data.coords.join(".")].entities.splice(c, 1);
          c = -1;
        }

        c--;
      }
    }
  } else if (message.command == "update entity") {

    entities = voxels[data.coords.join(".")].entities;

    if (entities != null) {

      c = entities.length - 1;

      while (c >= 0) {

        if (entities[c].id == data.entityId) {

          entities[c] = data.entity;
          c = -1;
        }

        c--;
      }
    }
  } else if (message.command == "update") {

    user.position = data.position;
    user.velocity = data.velocity;
    user.vrHeight = data.vrHeight;
  } else if (message.command == "start") {

    self.update();
  } else if (message.command == "stop") {

    self.stop();
  }
};

self.stop = function () {
  clearTimeout(self.updateLoop);
};

self.update = function () {

  var entities = [],
      user = observer,
      position = user.position,
      secondPos = null,
      coords = [Math.floor(position[0] / 42.18181818), 0, Math.floor(position[2] / 36.698181818181816)],
      key = "",
      obj = null,
      secondObj = null,
      x = -1,
      z = -1,
      i = 0,
      o = 0;

  while (x <= 2) {
    // only simulate entities in 9 voxels around the user

    while (z <= 2) {

      key = x + coords[0] + ".0." + (z + coords[2]);

      if (voxels[key] != null) {

        entities = voxels[key].entities;

        if (!!entities) {

          i = entities.length;

          while (i >= 0) {

            obj = entities[i];

            if (!!obj && !!obj.moving) {
              //moving) {

              o = entities.length - 1; // if moving, check collisions against all other entities (in that voxel)

              while (o >= 0) {

                secondObj = entities[o];
                secondPos = secondObj.position;

                if (distance3dCompare(secondPos, obj.position, obj.boundingRadius + secondObj.boundingRadius)) {
                  // look up the proper radius
                  // send back the new position and velocity for both entities
                  self.postMessage("{\"command\": \"entity-entity collision\", \"data\":{\"entities\":[{\"position\":[" + obj.position[0] + "," + obj.position[1] + "," + obj.position[2] + "],\"velocity\": [0, 0, 0] }, {\"position\":[" + secondPos[0] + "," + secondPos[1] + "," + secondPos[2] + "],\"velocity\": [0, 0, 0] }]}}");
                }

                o--;
              }
            }

            i--;
          }
        }
      }

      ++z;
    }

    ++x;
  }

  self.postMessage("{\"command\": \"update\"}");
  self.updateLoop = setTimeout(function () {
    self.update();
  }, 15);
};

// implement

// implement

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL1VzZXJzL29wZW5zL0FwcERhdGEvUm9hbWluZy9ucG0vbm9kZV9tb2R1bGVzL2Jyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL2Jyb3dzZXItcGFjay9fcHJlbHVkZS5qcyIsIkM6L0NvZGUvc3JjL2dpdGh1Yi5jb20vY29udm9sdnIvY29udm9sdnIvY2xpZW50L3NyYy9qcy93b3JrZXJzL2R5bmFtaWMtY29sbGlzaW9ucy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7QUNFQSxJQUFJLFVBQVUsR0FBRyxVQUFFLENBQUMsRUFBRSxDQUFDLEVBQU07O0FBRXpCLFNBQU8sSUFBSSxDQUFDLElBQUksQ0FBRSxJQUFJLENBQUMsR0FBRyxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQyxDQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFHLENBQUMsQ0FBRSxDQUFFLENBQUE7Q0FFM0U7SUFDRCxpQkFBaUIsR0FBRyxVQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFNOzs7QUFFbEMsU0FBTyxJQUFJLENBQUMsR0FBRyxDQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQyxDQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFHLENBQUMsQ0FBRSxHQUFJLENBQUMsR0FBQyxDQUFDLEFBQUMsQ0FBQTtDQUV0RTtJQUNELGlCQUFpQixHQUFHLFVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQU07OztBQUVsQyxTQUFPLEFBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsQ0FB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RyxnQ0FBOEIsQ0FBQyxDQUFBO2lCQUVsUzs7QUFFRCxpQkFBQyxFQUFHLENBQUE7ZUFFTDthQUVKOztBQUVELGFBQUMsRUFBRyxDQUFBO1dBRUw7U0FFRjtPQUVGOztBQUVELFFBQUcsQ0FBQyxDQUFBO0tBRUw7O0FBRUQsTUFBRyxDQUFDLENBQUE7R0FFTDs7QUFFRCxNQUFJLENBQUMsV0FBVyxDQUFDLDJCQUF1QixDQUFDLENBQUE7QUFDMUMsTUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUUsWUFBTTtBQUNuQyxRQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7R0FDYixFQUFFLEVBQUUsQ0FBQyxDQUFBO0NBRU4sQ0FBQSIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpO3Rocm93IGYuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCIvKiBlbnRpdHkgd29ya2VyICovXHJcbi8vIGNvbGxpc2lvbnMgYnR3ZWVuIGVudGl0aWVzIGluIG1vdGlvbiBhbmQgb3RoZXIgZW50aXRpZXNcclxubGV0IGRpc3RhbmNlMmQgPSAoIGEsIGIgKSA9PiB7XHJcblxyXG4gICAgcmV0dXJuIE1hdGguc3FydCggTWF0aC5wb3coKGFbMF0tYlswXSksIDIgKSArIE1hdGgucG93KCAoYVsyXS1iWzJdKSwgMiApIClcclxuXHJcbiAgfSxcclxuICBkaXN0YW5jZTJkQ29tcGFyZSA9ICggYSwgYiwgbiApID0+IHsgLy8gbW9yZSBlZmZpY2llbnQgdmVyc2lvbiBvZiBkaXN0YW5jZTJkKClcclxuXHJcblx0ICByZXR1cm4gTWF0aC5wb3coIChhWzBdLWJbMF0pLCAyICkgKyBNYXRoLnBvdyggKGFbMl0tYlsyXSksIDIgKSA8IChuKm4pXHJcblxyXG4gIH0sXHJcbiAgZGlzdGFuY2UzZENvbXBhcmUgPSAoIGEsIGIsIG4gKSA9PiB7IC8vIC4uZmFzdGVyIHRoYW4gdXNpbmcgTWF0aC5zcXJ0KClcclxuXHJcblx0ICByZXR1cm4gKE1hdGgucG93KCAoYVswXS1iWzBdKSwgMiApICsgTWF0aC5wb3coIChhWzFdLWJbMV0pLCAyICkgKyBNYXRoLnBvdyggKGFbMl0tYlsyXSksIDIgKSkgPCAobipuKVxyXG5cclxuICB9XHJcblxyXG5sZXQgdm94ZWxMaXN0ID0gW10sXHJcblx0ICB2b3hlbHMgPSB7fSwgLy8gbWFwIG9mIHN0cmluZyBjb29yZGluYXRlcyB0byBhcnJheXMgb2YgZW50aXRpZXNcclxuICAgIG9ic2VydmVyID0ge1xyXG4gIFx0XHRwb3NpdGlvbjogWzAsIDAsIDBdLFxyXG4gIFx0XHRwcmV2UG9zOiBbMCwgMCwgMF0sXHJcbiAgXHRcdHZlbG9jaXR5OiBbMCwgMCwgMF0sXHJcbiAgICAgIGhhbmRzOiBbXSxcclxuICBcdFx0dnJIZWlnaHQ6IDBcclxuICBcdH1cclxuXHJcbnNlbGYub25tZXNzYWdlID0gZXZlbnQgPT4geyAvLyBwcm9iYWJseSBnb2luZyB0byByZXBsYWNlIG1vc3Qgb2YgdGhpcyB3b3JrZXIgd2l0aCBDYW5ub24uanMuLiAmIGNhbiBmYWxsYmFjayB0byBzdGF0aWMtY29sbGlzaW9uIHdvcmtlciBpbiBtb3N0IGNhc2VzIFxyXG5cclxuXHRsZXQgbWVzc2FnZSA9IEpTT04ucGFyc2UoZXZlbnQuZGF0YSksXHJcblx0XHRcdGRhdGEgPSBtZXNzYWdlLmRhdGEsXHJcbiAgICAgIGVudGl0aWVzID0gW10sXHJcbiAgICAgIHRvUmVtb3ZlID0gbnVsbCxcclxuICAgICAgdm94ZWwgPSBudWxsLFxyXG4gICAgICB1c2VyID0gb2JzZXJ2ZXIsXHJcblx0XHRcdGMgPSAwXHJcblxyXG4gIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwic2V0IGluIG1vdGlvblwiICkge1xyXG4gICAgLy8gaW1wbGVtZW50XHJcblxyXG4gIH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcImJlY29tZSBzdGF0aWNcIiApIHtcclxuICAgIC8vIGltcGxlbWVudFxyXG5cclxuICB9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJhZGQgdm94ZWxzXCIgKSB7XHJcblxyXG4gICAgdm94ZWxMaXN0ID0gdm94ZWxMaXN0LmNvbmNhdChkYXRhKVxyXG5cclxuXHRcdGRhdGEubWFwKCB2ID0+IHtcclxuICAgICAgXHJcblx0XHRcdHZveGVsc1sgdi5jZWxsLmpvaW4oXCIuXCIpIF0gPSB2XHJcblxyXG5cdFx0fSlcclxuXHJcbiAgfSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwicmVtb3ZlIHZveGVsc1wiICkge1xyXG5cclxuICAgIGMgPSBkYXRhLmxlbmd0aCAtMVxyXG5cclxuXHRcdHdoaWxlICggYyA+PSAwICkge1xyXG5cclxuXHRcdFx0dG9SZW1vdmUgPSBkYXRhWyBjIF1cclxuICAgICAgdm94ZWxMaXN0LnNwbGljZSggdm94ZWxMaXN0LmluZGV4T2Yodm94ZWxzWyB0b1JlbW92ZS5jZWxsIF0pICwgMSApXHJcbiAgICAgIHZveGVsc1sgdG9SZW1vdmUuY2VsbCBdID0gbnVsbFxyXG5cdFx0XHRjIC0tXHJcblxyXG5cdFx0fVxyXG5cclxuICB9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJhZGQgZW50aXR5XCIgKSB7XHJcblxyXG4gICAgZW50aXRpZXMgPSB2b3hlbHNbZGF0YS5jb29yZHMuam9pbihcIi5cIildLmVudGl0aWVzXHJcblxyXG4gICAgaWYgKGVudGl0aWVzICE9IG51bGwpIHtcclxuXHJcbiAgICAgIHZveGVsc1sgZGF0YS5jb29yZHMuam9pbihcInhcIikgXS5lbnRpdGllcy5wdXNoKGRhdGEuZW50aXR5KVxyXG5cclxuICAgIH1cclxuXHJcbiAgfSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwicmVtb3ZlIGVudGl0eVwiICkge1xyXG5cclxuICAgIGVudGl0aWVzID0gdm94ZWxzW2RhdGEuY29vcmRzLmpvaW4oXCIuXCIpXS5lbnRpdGllc1xyXG5cclxuICAgIGlmICggZW50aXRpZXMgIT0gbnVsbCApIHtcclxuXHJcbiAgICAgIGMgPSBlbnRpdGllcy5sZW5ndGgtMVxyXG5cclxuICBcdFx0d2hpbGUgKCBjID49IDAgKSB7XHJcblxyXG4gIFx0XHRcdGlmICggZW50aXRpZXNbIGMgXS5pZCA9PSBkYXRhLmVudGl0eUlkICkge1xyXG5cclxuICBcdFx0XHRcdHZveGVsc1tkYXRhLmNvb3Jkcy5qb2luKFwiLlwiKV0uZW50aXRpZXMuc3BsaWNlKCBjLCAxIClcclxuICAgICAgICAgIGMgPSAtMVxyXG5cclxuICAgICAgICB9XHJcblxyXG4gIFx0XHRcdGMtLVxyXG5cclxuICBcdFx0fVxyXG5cclxuICAgIH1cclxuXHJcbiAgfSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwidXBkYXRlIGVudGl0eVwiICkge1xyXG5cclxuXHRcdGVudGl0aWVzID0gdm94ZWxzWyBkYXRhLmNvb3Jkcy5qb2luKFwiLlwiKSBdLmVudGl0aWVzXHJcblxyXG5cdFx0aWYgKCBlbnRpdGllcyAhPSBudWxsICkge1xyXG5cclxuXHRcdFx0YyA9IGVudGl0aWVzLmxlbmd0aC0xXHJcblxyXG5cdFx0XHR3aGlsZSAoIGMgPj0gMCApIHtcclxuXHJcblx0XHRcdFx0aWYgKCBlbnRpdGllc1sgYyBdLmlkID09IGRhdGEuZW50aXR5SWQgKSB7XHJcblxyXG5cdFx0XHRcdFx0ZW50aXRpZXNbIGMgXSA9IGRhdGEuZW50aXR5XHJcblx0XHRcdFx0XHRjID0gLTFcclxuXHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRjLS1cclxuXHJcblx0XHRcdH1cclxuXHJcblx0XHR9XHJcblxyXG5cdH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcInVwZGF0ZVwiICkge1xyXG5cclxuICAgIHVzZXIucG9zaXRpb24gPSBkYXRhLnBvc2l0aW9uXHJcblx0XHR1c2VyLnZlbG9jaXR5ID0gZGF0YS52ZWxvY2l0eVxyXG5cdFx0dXNlci52ckhlaWdodCA9IGRhdGEudnJIZWlnaHRcclxuXHJcbiAgfSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwic3RhcnRcIiApIHtcclxuXHJcblx0XHRzZWxmLnVwZGF0ZSgpXHJcblxyXG5cdH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcInN0b3BcIiApIHtcclxuXHJcblx0XHRzZWxmLnN0b3AoKVxyXG5cclxuICB9XHJcbn07XHJcblxyXG5zZWxmLnN0b3AgPSAoKSA9PiB7XHJcblx0Y2xlYXJUaW1lb3V0KHNlbGYudXBkYXRlTG9vcCk7XHJcbn1cclxuXHJcbnNlbGYudXBkYXRlID0gKCkgPT4ge1xyXG5cclxuICBsZXQgZW50aXRpZXMgPSBbXSxcclxuICAgICAgdXNlciA9IG9ic2VydmVyLFxyXG4gICAgICBwb3NpdGlvbiA9IHVzZXIucG9zaXRpb24sXHJcbiAgICAgIHNlY29uZFBvcyA9IG51bGwsXHJcbiAgICAgIGNvb3JkcyA9IFtNYXRoLmZsb29yKHBvc2l0aW9uWzBdLzkyODAwMCksIDAsIE1hdGguZmxvb3IocG9zaXRpb25bMl0vODA3MzYwKV0sXHJcbiAgICAgIGtleSA9ICcnLFxyXG4gICAgICBvYmogPSBudWxsLFxyXG4gICAgICBzZWNvbmRPYmogPSBudWxsLFxyXG4gICAgICB4ID0gLSAxLFxyXG4gICAgICB6ID0gLSAxLFxyXG4gICAgICBpID0gMCxcclxuICAgICAgbyA9IDBcclxuXHJcbiAgd2hpbGUgKCB4IDw9IDIgKSB7IC8vIG9ubHkgc2ltdWxhdGUgZW50aXRpZXMgaW4gOSB2b3hlbHMgYXJvdW5kIHRoZSB1c2VyXHJcblxyXG4gICAgd2hpbGUgKCB6IDw9IDIgKSB7XHJcblxyXG4gICAgICBrZXkgPSAoeCtjb29yZHNbMF0pKycuMC4nKyh6K2Nvb3Jkc1syXSlcclxuXHJcbiAgICAgIGlmICggdm94ZWxzW2tleV0gIT0gbnVsbCApIHtcclxuXHJcbiAgICAgICAgZW50aXRpZXMgPSB2b3hlbHNba2V5XS5lbnRpdGllc1xyXG5cclxuICAgICAgICBpZiAoICEhZW50aXRpZXMgKSB7XHJcblxyXG4gICAgICAgICAgaSA9IGVudGl0aWVzLmxlbmd0aFxyXG5cclxuICAgICAgICAgIHdoaWxlICggaSA+PSAwICkge1xyXG5cclxuICAgICAgICAgICAgb2JqID0gZW50aXRpZXNbaV1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmICggISFvYmogJiYgISEgb2JqLm1vdmluZyApIHsgLy9tb3ZpbmcpIHtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgIG8gPSBlbnRpdGllcy5sZW5ndGggLTEgLy8gaWYgbW92aW5nLCBjaGVjayBjb2xsaXNpb25zIGFnYWluc3QgYWxsIG90aGVyIGVudGl0aWVzIChpbiB0aGF0IHZveGVsKVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICB3aGlsZSAoIG8gPj0gMCApIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgIHNlY29uZE9iaiA9IGVudGl0aWVzW29dXHJcbiAgICAgICAgICAgICAgICAgIHNlY29uZFBvcyA9IHNlY29uZE9iai5wb3NpdGlvblxyXG5cclxuICAgICAgICAgICAgICAgICAgaWYgKGRpc3RhbmNlM2RDb21wYXJlKHNlY29uZFBvcywgb2JqLnBvc2l0aW9uLCBvYmouYm91bmRpbmdSYWRpdXMrc2Vjb25kT2JqLmJvdW5kaW5nUmFkaXVzKSkgeyAvLyBsb29rIHVwIHRoZSBwcm9wZXIgcmFkaXVzXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gc2VuZCBiYWNrIHRoZSBuZXcgcG9zaXRpb24gYW5kIHZlbG9jaXR5IGZvciBib3RoIGVudGl0aWVzXHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSgne1wiY29tbWFuZFwiOiBcImVudGl0eS1lbnRpdHkgY29sbGlzaW9uXCIsIFwiZGF0YVwiOntcImVudGl0aWVzXCI6W3tcInBvc2l0aW9uXCI6Wycrb2JqLnBvc2l0aW9uWzBdICsgJywnICsgb2JqLnBvc2l0aW9uWzFdICsgJywnICsgb2JqLnBvc2l0aW9uWzJdICsgJ10sXCJ2ZWxvY2l0eVwiOiBbMCwgMCwgMF0gfSwge1wicG9zaXRpb25cIjpbJytzZWNvbmRQb3NbMF0gKyAnLCcgKyBzZWNvbmRQb3NbMV0gKyAnLCcgKyBzZWNvbmRQb3NbMl0gKyAnXSxcInZlbG9jaXR5XCI6IFswLCAwLCAwXSB9XX19JylcclxuXHJcbiAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgIG8gLS1cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpIC0tXHJcblxyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICB9XHJcblxyXG4gICAgICArKyB6XHJcblxyXG4gICAgfVxyXG5cclxuICAgICsrIHhcclxuXHJcbiAgfVxyXG5cclxuICBzZWxmLnBvc3RNZXNzYWdlKCd7XCJjb21tYW5kXCI6IFwidXBkYXRlXCJ9JylcclxuXHRzZWxmLnVwZGF0ZUxvb3AgPSBzZXRUaW1lb3V0KCAoKSA9PiB7XHJcblx0XHRzZWxmLnVwZGF0ZSgpXHJcblx0fSwgMTUpXHJcblxyXG59XHJcbiJdfQ==
